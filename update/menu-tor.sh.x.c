#if 0
	shc Version 4.0.3, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -U -f menu-tor.sh 
#endif

static  char data [] = 
#define      rlax_z	1
#define      rlax	((&data[0]))
	"\041"
#define      date_z	1
#define      date	((&data[1]))
	"\324"
#define      shll_z	10
#define      shll	((&data[2]))
	"\046\302\031\060\270\041\035\323\342\357\141"
#define      chk2_z	19
#define      chk2	((&data[16]))
	"\043\020\172\215\036\023\251\253\061\137\370\076\034\071\046\203"
	"\045\255\232\007\370\361\374\016"
#define      msg1_z	65
#define      msg1	((&data[40]))
	"\115\271\004\310\200\150\370\350\312\264\177\232\315\100\051\223"
	"\262\211\055\237\172\232\250\221\330\101\244\032\201\021\202\040"
	"\222\107\316\152\040\230\275\135\312\106\077\124\244\355\364\217"
	"\354\021\175\007\213\343\210\233\344\104\266\363\377\070\274\041"
	"\247\023\054\302\052\347\225\374"
#define      tst2_z	19
#define      tst2	((&data[112]))
	"\236\106\166\237\357\374\072\331\337\216\164\116\236\237\252\236"
	"\137\333\274\075\206\161"
#define      text_z	2065
#define      text	((&data[444]))
	"\012\267\152\153\255\062\350\321\103\142\315\121\175\374\216\313"
	"\266\222\365\235\050\361\213\312\042\051\020\231\367\253\166\001"
	"\143\341\155\021\023\125\342\127\270\257\250\066\253\067\001\142"
	"\312\366\377\362\350\212\275\012\264\316\243\253\172\032\255\335"
	"\373\032\357\017\160\321\147\051\201\020\137\055\107\141\217\021"
	"\130\216\004\100\031\301\113\316\220\357\171\012\012\047\350\006"
	"\101\327\025\262\251\174\333\053\214\073\130\324\234\350\346\365"
	"\167\353\066\221\254\201\137\074\161\331\107\173\000\057\201\102"
	"\007\227\364\260\024\320\333\241\013\064\165\250\034\134\235\224"
	"\107\323\045\364\125\205\061\307\136\170\103\137\250\304\241\257"
	"\134\226\137\161\146\073\022\161\160\210\031\214\344\267\041\054"
	"\213\106\040\341\314\121\250\052\312\353\211\162\260\053\041\015"
	"\301\201\176\047\274\220\230\054\031\262\271\375\152\333\051\365"
	"\042\112\327\356\233\177\030\145\153\242\330\033\315\371\050\216"
	"\172\247\265\067\070\116\144\121\001\036\117\153\371\171\141\034"
	"\303\070\012\137\270\043\304\043\305\234\077\223\226\150\042\021"
	"\017\330\111\107\046\256\230\050\314\347\224\306\141\365\342\044"
	"\056\355\203\346\020\110\011\326\345\110\152\173\260\214\215\300"
	"\144\326\007\213\204\240\263\121\210\107\027\351\075\372\015\153"
	"\350\220\121\371\331\133\320\276\244\221\127\136\070\262\363\372"
	"\333\120\200\104\013\366\172\377\270\277\215\166\014\005\110\050"
	"\151\101\230\230\034\221\133\373\176\134\240\335\303\350\102\003"
	"\301\165\350\341\232\162\100\314\160\167\203\071\050\133\056\360"
	"\306\022\334\255\132\174\031\023\147\233\330\144\045\164\005\317"
	"\233\325\015\042\372\265\046\141\050\163\222\320\344\355\327\327"
	"\060\154\034\333\103\171\265\305\366\206\174\367\055\064\023\313"
	"\371\263\124\052\237\370\311\106\132\255\155\347\040\005\320\244"
	"\066\377\144\047\335\267\360\116\102\200\013\163\346\066\201\170"
	"\044\036\320\052\202\374\244\027\364\032\120\340\237\317\222\015"
	"\371\362\010\030\377\120\332\077\031\242\101\040\034\373\165\206"
	"\275\253\076\151\014\174\120\355\376\237\342\030\131\031\073\062"
	"\120\115\072\243\221\214\030\232\266\172\370\336\153\355\245\135"
	"\061\035\143\354\264\164\303\160\226\353\012\175\156\043\127\350"
	"\033\126\326\215\152\066\251\336\065\246\074\066\120\303\030\301"
	"\131\040\333\003\114\305\146\101\006\260\247\017\026\140\166\132"
	"\102\151\114\076\361\144\267\231\322\337\301\213\015\223\154\135"
	"\120\010\343\357\210\047\144\270\114\270\156\366\106\346\267\270"
	"\227\241\243\230\023\362\152\271\206\117\235\173\270\152\213\127"
	"\223\237\215\113\200\204\357\002\235\063\153\024\317\065\331\204"
	"\342\212\057\357\250\360\356\271\122\344\213\371\315\310\040\105"
	"\345\363\006\312\314\152\320\235\312\003\330\202\000\123\257\324"
	"\252\303\232\055\224\204\265\267\354\370\235\215\236\171\335\036"
	"\254\137\072\231\354\150\073\236\363\256\074\115\270\103\063\375"
	"\273\163\003\060\307\354\114\136\206\235\054\167\260\225\237\215"
	"\021\064\211\267\325\012\047\042\010\233\140\143\072\153\372\035"
	"\112\165\276\116\144\241\340\301\161\274\302\330\077\174\170\112"
	"\126\365\331\354\346\060\052\111\217\047\363\134\343\056\312\250"
	"\057\133\160\245\073\067\355\226\211\154\112\256\116\204\077\267"
	"\241\154\166\005\153\361\271\364\167\310\034\367\310\033\076\303"
	"\371\213\061\277\025\215\127\145\075\176\346\101\135\023\045\365"
	"\003\310\146\162\136\372\251\262\271\255\232\167\061\240\327\110"
	"\017\227\060\004\235\225\374\210\246\362\151\352\023\111\365\152"
	"\134\213\346\221\323\377\045\213\136\230\336\215\347\211\022\346"
	"\207\355\360\120\232\024\036\343\313\062\121\066\342\057\147\062"
	"\075\333\331\342\305\372\241\333\014\303\075\331\316\316\301\103"
	"\206\033\220\170\152\037\100\126\141\135\210\204\145\105\353\024"
	"\151\121\116\112\135\136\340\324\155\225\365\021\225\343\065\334"
	"\077\274\046\045\201\203\337\300\143\221\311\160\332\254\301\241"
	"\003\141\307\074\063\102\256\152\160\365\375\243\263\350\141\317"
	"\315\143\045\164\343\367\054\131\335\336\264\075\046\342\251\126"
	"\066\141\236\271\006\221\252\206\320\050\150\312\142\321\020\064"
	"\331\102\206\134\144\142\110\206\277\021\260\147\144\172\074\275"
	"\377\361\343\215\240\025\272\072\277\316\021\043\345\232\017\031"
	"\226\276\152\324\313\143\073\066\240\210\210\261\333\215\372\362"
	"\372\040\236\244\302\125\036\311\212\276\236\176\320\234\132\251"
	"\004\172\050\174\303\203\327\067\251\312\123\014\163\076\126\224"
	"\142\333\264\206\243\243\242\206\300\017\140\065\304\342\304\305"
	"\004\162\054\313\363\214\207\251\260\316\321\235\045\053\152\132"
	"\071\124\020\152\010\330\227\220\207\253\166\165\057\340\324\004"
	"\177\351\215\156\327\213\075\313\166\013\231\317\156\173\206\354"
	"\075\022\232\001\164\007\042\355\116\310\305\223\174\307\320\217"
	"\224\113\147\337\157\214\040\263\127\152\014\056\251\244\013\015"
	"\276\341\261\050\011\015\237\035\143\176\016\365\107\166\167\052"
	"\226\342\377\102\105\355\364\206\223\336\317\177\146\222\367\013"
	"\233\344\320\050\240\002\274\363\143\254\370\377\351\316\223\223"
	"\075\114\043\000\131\145\367\166\255\302\132\237\171\375\107\067"
	"\074\040\262\333\350\041\264\152\210\076\066\077\120\212\005\212"
	"\107\237\170\011\062\372\263\154\105\263\222\271\236\070\176\336"
	"\200\124\315\142\131\266\155\251\240\065\375\066\324\027\050\032"
	"\331\056\207\166\247\216\350\243\267\250\010\163\273\230\137\301"
	"\245\030\165\040\311\105\370\273\152\242\213\152\336\104\121\372"
	"\106\256\174\015\116\156\056\366\042\115\063\314\013\075\004\103"
	"\010\315\164\043\017\155\047\000\172\367\123\361\152\316\202\305"
	"\012\164\171\220\313\163\054\103\016\254\267\364\366\040\127\010"
	"\005\274\320\072\017\075\325\060\134\127\031\224\156\212\065\244"
	"\127\041\277\062\324\356\255\031\323\343\276\266\075\163\201\065"
	"\146\030\000\273\046\030\321\276\153\233\307\237\250\136\006\233"
	"\256\060\061\256\225\155\054\105\347\176\325\360\041\151\121\356"
	"\360\254\071\340\035\033\075\350\315\345\007\064\005\344\023\073"
	"\024\320\320\254\343\247\152\105\233\155\235\303\231\000\027\032"
	"\354\202\041\176\155\111\264\150\214\117\352\170\270\215\375\161"
	"\005\167\226\042\321\167\143\004\177\012\334\257\241\163\365\216"
	"\303\256\260\151\225\334\255\202\251\361\247\320\244\070\163\100"
	"\176\144\213\126\224\324\247\171\163\062\157\065\172\243\367\217"
	"\113\120\223\252\233\307\156\205\373\367\134\064\137\370\321\305"
	"\172\007\043\342\317\020\333\151\045\334\304\243\143\174\133\164"
	"\146\113\303\325\303\227\252\037\025\041\036\021\361\133\233\051"
	"\332\310\273\132\202\020\227\045\112\060\054\111\213\154\064\032"
	"\066\146\142\107\254\275\112\233\254\062\330\226\173\305\273\202"
	"\365\135\324\050\026\141\024\277\245\077\320\104\066\137\105\325"
	"\033\104\235\141\326\031\021\333\135\032\053\333\061\246\273\041"
	"\017\214\303\162\277\043\155\131\221\345\200\024\060\041\243\202"
	"\012\121\262\177\302\003\042\054\270\100\116\351\042\014\011\236"
	"\246\066\302\314\363\334\340\143\043\300\371\054\174\165\041\362"
	"\153\215\205\052\041\324\071\375\124\372\114\003\053\214\362\365"
	"\150\224\261\336\364\140\050\272\231\107\341\203\200\213\056\260"
	"\016\100\033\054\102\242\367\164\047\161\333\247\322\046\067\177"
	"\323\056\375\033\236\311\364\167\302\267\127\364\137\347\136\107"
	"\221\274\263\005\111\100\213\106\352\274\374\232\010\102\377\376"
	"\026\224\016\226\060\143\123\113\035\210\340\134\243\310\053\027"
	"\325\140\321\115\312\157\145\030\000\234\004\037\023\205\334\334"
	"\204\160\046\073\171\166\005\240\270\270\034\360\006\170\062\160"
	"\372\214\270\341\160\310\022\043\330\051\061\005\373\073\145\132"
	"\344\146\260\043\015\322\207\054\147\341\033\045\041\103\341\066"
	"\211\310\306\330\240\152\166\217\105\006\224\041\050\017\024\023"
	"\366\042\045\033\250\366\352\347\124\246\325\365\263\336\071\265"
	"\304\300\145\377\112\235\101\366\241\141\251\213\271\177\122\113"
	"\170\106\343\334\152\061\047\233\256\333\074\327\276\011\032\371"
	"\360\117\233\372\241\131\225\315\015\161\153\130\010\034\152\014"
	"\160\211\050\274\144\366\347\340\111\375\346\251\105\057\116\037"
	"\153\107\314\200\337\147\047\336\351\351\373\315\364\075\042\335"
	"\236\261\336\011\151\065\013\122\222\251\321\233\262\223\260\324"
	"\340\306\143\166\264\167\050\030\320\303\303\205\041\316\217\317"
	"\230\205\257\145\125\127\144\117\066\110\247\046\146\311\045\214"
	"\313\207\354\203\072\003\331\244\061\320\015\032\361\174\364\247"
	"\103\036\131\274\362\066\334\171\130\244\151\115\075\204\042\042"
	"\375\233\160\012\260\225\111\207\106\257\216\077\262\130\060\240"
	"\267\051\016\354\327\020\152\201\000\233\300\365\060\226\363\370"
	"\013\121\347\272\322\331\001\261\307\256\151\031\071\171\343\334"
	"\043\151\076\040\047\131\141\146\230\272\121\267\244\211\043\266"
	"\377\303\256\072\105\134\171\031\227\031\100\011\320\344\123\214"
	"\000\155\370\360\275\327\173\002\225\247\247\021\256\037\017\226"
	"\202\221\310\314\166\123\205\031\026\112\103\256\134\007\130\147"
	"\261\367\117\154\361\231\050\244\056\357\223\113\111\244\306\354"
	"\122\322\166\063\161\317\200\060\043\165\156\323\064\014\077\311"
	"\073\043\020\214\061\100\346\111\121\213\253\241\356\326\111\161"
	"\245\243\022\343\132\154\376\066\314\220\307\372\333\142\003\023"
	"\373\003\312\072\242\300\070\053\367\351\326\041\271\300\244\237"
	"\031\164\043\175\247\277\206\314\326\043\360\007\066\157\321\102"
	"\250\325\153\346\337\143\327\372\133\040\150\336\366\360\142\216"
	"\237\332\165\004\172\252\101\033\347\311\213\055\234\337\032\265"
	"\122\256\223\205\037\227\314\133\074\164\225\211\374\150\221\156"
	"\047\367\131\136\275\233\123\011\122\344\025\132\050\125\313\072"
	"\336\346\161\366\373\262\255\300\214\320\071\173\166\333\266\023"
	"\077\127\172\101\306\311\175\132\035\360\274\100\006\127\117\177"
	"\237\230\174\260\261\107\336\236\315\346\274\145\217\262\364\140"
	"\265\324\027\166\060\334\200\336\050\355\066\273\154\333\050\337"
	"\226\340\350\236\041\234\010\142\234\261\200\160\036\343\352\053"
	"\047\341\241\215\271\162\247\232\125\142\072\071\125\306\306\025"
	"\053\235\034\267\041\275\152\162\105\262\212\056\357\205\074\133"
	"\155\315\255\146\246\011\066\144\255\161\236\002\070\145\030\143"
	"\002\065\032\043\362\205\226\067\070\040\146\050\246\242\203\023"
	"\157\061\172\026\072\261\172\350\042\030\353\132\176\003\276\200"
	"\070\330\244\053\136\072\142\226\133\311\276\001\154\102\025\334"
	"\163\217\362\255\100\154\225\143\205\200\275\003\204\173\204\274"
	"\124\050\347\262\143\112\111\276\024\007\300\200\111\326\134\274"
	"\145\116\152\246\273\000\012\101\200\307\104\004\103\311\301\230"
	"\361\251\113\124\364\224\023\010\234\324\210\345\252\345\242\020"
	"\064\015\266\357\015\301\060\215\210\165\222\314\076\124\144\060"
	"\375\260\205\361\104\231\372\340\155\202\306\027\150\151\047\234"
	"\166\336\213\203\237\274\021\050\062\244\365\161\370\131\242\366"
	"\012\047\350\116\300\342\057\056\144\366\105\315\140\155\151\326"
	"\114\365\132\353\261\154\024\344\020\011\125\011\143\367\377\155"
	"\037\347\274\337\311\353\015\056\342\123\373\102\300\144\031\015"
	"\131\163\370\013\337\015\357\360\026\105\371\172\074\371\347\133"
	"\340\244\073\252\220\111\330\162\235\324\265\136\070\316\153\222"
	"\102\144\235\042\161\215\022\210\322\014\003\017\005\353\152\346"
	"\217\246\220\037\360\151\222\215\075\107\354\165\026\127\010\130"
	"\273\245\172\055\063\215\266\005\231\271\024\237\244\177\205\064"
	"\046\026\123\026\177\345\244\274\055\220\061\103\350\071\233\244"
	"\337\026\322\022\243\210\030\075\102\054\335\347\253\143\033\322"
	"\171\157\350\370\125\215\264\202\036\346\305\006\040\141\252\000"
	"\167\174\023\033\005\053\131\107\127\066\057\003\232\113\325\023"
	"\272\276\014\017\113\301\221\151\247\127\157\310\270\032\310\057"
	"\227\333\113\234\006\244\344\136\333\023\141\165\137\067\211\031"
	"\365\225\051\101\127\273\252\376\022\032\307\313\065\220\372\314"
	"\154\106\151\163\353\115\321\306\141"
#define      inlo_z	3
#define      inlo	((&data[2956]))
	"\030\027\011"
#define      lsto_z	1
#define      lsto	((&data[2959]))
	"\155"
#define      xecc_z	15
#define      xecc	((&data[2961]))
	"\242\302\244\262\373\354\263\027\121\075\167\011\212\327\204\247"
#define      opts_z	1
#define      opts	((&data[2976]))
	"\136"
#define      pswd_z	256
#define      pswd	((&data[3030]))
	"\171\234\235\012\227\152\166\335\323\351\310\040\273\217\201\357"
	"\314\102\132\223\034\273\357\037\135\242\336\253\125\257\023\317"
	"\114\261\331\343\033\117\301\356\071\212\017\365\031\221\345\346"
	"\323\100\171\357\373\347\001\050\301\332\372\025\001\213\034\007"
	"\240\272\017\120\065\063\257\215\340\055\347\231\046\147\235\070"
	"\350\174\213\026\143\215\076\045\147\070\073\150\303\130\157\144"
	"\022\177\264\110\263\144\326\224\221\275\055\270\045\312\360\015"
	"\106\174\043\252\011\142\317\160\233\012\331\137\142\111\303\165"
	"\311\170\276\174\334\224\020\155\121\076\046\166\010\027\204\117"
	"\223\250\371\235\012\310\016\245\323\350\004\065\061\310\253\373"
	"\100\151\167\035\375\210\213\116\306\261\305\317\310\112\036\134"
	"\362\030\371\375\340\007\243\264\360\250\351\041\160\225\034\261"
	"\376\224\316\373\035\131\112\344\013\020\263\323\133\322\057\115"
	"\352\051\113\313\061\356\177\041\226\151\103\007\376\140\270\375"
	"\364\207\371\021\340\104\365\353\125\251\277\260\173\357\376\146"
	"\031\111\062\112\070\261\154\316\033\257\326\031\017\216\027\004"
	"\026\020\026\366\125\014\342\252\265\242\132\061\221\130\230\252"
	"\241\312\365\331\173\141\250\226\021\177\260\041\016\310\045\044"
	"\330\073\033\056\107\376\330\375\240\062\056\062\213\307\334\055"
	"\221\322\007\015\064\150\017\131\013\355\004\140\235\030\057\351"
	"\311\011\314\344\131\215\323\222\027\342\210\061\164\155\027"
#define      tst1_z	22
#define      tst1	((&data[3316]))
	"\070\251\372\107\056\050\020\151\350\213\151\370\005\051\265\365"
	"\075\141\363\142\035\050\371\345\132\275\003\005\065"
#define      chk1_z	22
#define      chk1	((&data[3343]))
	"\040\226\223\226\331\344\044\037\062\027\002\002\202\044\015\263"
	"\000\213\370\362\162\070\077\337\273\351\237\210"
#define      msg2_z	19
#define      msg2	((&data[3373]))
	"\241\213\055\204\172\321\006\314\234\320\306\356\150\070\207\131"
	"\175\113\133\313\351\357\336"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	0	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

#if HARDENING
static const char * shc_x[] = {
"/*",
" * Copyright 2019 - Intika <intika@librefox.org>",
" * Replace ******** with secret read from fd 21",
" * Also change arguments location of sub commands (sh script commands)",
" * gcc -Wall -fpic -shared -o shc_secret.so shc_secret.c -ldl",
" */",
"",
"#define _GNU_SOURCE /* needed to get RTLD_NEXT defined in dlfcn.h */",
"#define PLACEHOLDER \"********\"",
"#include <dlfcn.h>",
"#include <stdlib.h>",
"#include <string.h>",
"#include <unistd.h>",
"#include <stdio.h>",
"#include <signal.h>",
"",
"static char secret[128000]; //max size",
"typedef int (*pfi)(int, char **, char **);",
"static pfi real_main;",
"",
"// copy argv to new location",
"char **copyargs(int argc, char** argv){",
"    char **newargv = malloc((argc+1)*sizeof(*argv));",
"    char *from,*to;",
"    int i,len;",
"",
"    for(i = 0; i<argc; i++){",
"        from = argv[i];",
"        len = strlen(from)+1;",
"        to = malloc(len);",
"        memcpy(to,from,len);",
"        // zap old argv space",
"        memset(from,'\\0',len);",
"        newargv[i] = to;",
"        argv[i] = 0;",
"    }",
"    newargv[argc] = 0;",
"    return newargv;",
"}",
"",
"static int mymain(int argc, char** argv, char** env) {",
"    //fprintf(stderr, \"Inject main argc = %d\\n\", argc);",
"    return real_main(argc, copyargs(argc,argv), env);",
"}",
"",
"int __libc_start_main(int (*main) (int, char**, char**),",
"                      int argc,",
"                      char **argv,",
"                      void (*init) (void),",
"                      void (*fini)(void),",
"                      void (*rtld_fini)(void),",
"                      void (*stack_end)){",
"    static int (*real___libc_start_main)() = NULL;",
"    int n;",
"",
"    if (!real___libc_start_main) {",
"        real___libc_start_main = dlsym(RTLD_NEXT, \"__libc_start_main\");",
"        if (!real___libc_start_main) abort();",
"    }",
"",
"    n = read(21, secret, sizeof(secret));",
"    if (n > 0) {",
"      int i;",
"",
"    if (secret[n - 1] == '\\n') secret[--n] = '\\0';",
"    for (i = 1; i < argc; i++)",
"        if (strcmp(argv[i], PLACEHOLDER) == 0)",
"          argv[i] = secret;",
"    }",
"",
"    real_main = main;",
"",
"    return real___libc_start_main(mymain, argc, argv, init, fini, rtld_fini, stack_end);",
"}",
"",
0};
#endif /* HARDENING */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a process */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void shc_x_file() {
    FILE *fp;
    int line = 0;

    if ((fp = fopen("/tmp/shc_x.c", "w")) == NULL ) {exit(1); exit(1);}
    for (line = 0; shc_x[line]; line++)	fprintf(fp, "%s\n", shc_x[line]);
    fflush(fp);fclose(fp);
}

int make() {
	char * cc, * cflags, * ldflags;
    char cmd[4096];

	cc = getenv("CC");
	if (!cc) cc = "cc";

	sprintf(cmd, "%s %s -o %s %s", cc, "-Wall -fpic -shared", "/tmp/shc_x.so", "/tmp/shc_x.c -ldl");
	if (system(cmd)) {remove("/tmp/shc_x.c"); return -1;}
	remove("/tmp/shc_x.c"); return 0;
}

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    char tmp3[len+1024];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;
    int lentmp = len;
    int pid, status;
    pid = fork();

    shc_x_file();
    if (make()) {exit(1);}

    setenv("LD_PRELOAD","/tmp/shc_x.so",1);

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Do the magic
        sprintf(tmp3, "%s %s", "'********' 21<<<", tmp2);

        //Exec bash script //fork execl with 'sh -c'
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Clean temp
        remove("/tmp/shc_x.so");

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {wait(&status);}

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
}
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
